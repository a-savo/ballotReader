fill_na() %>%
na.omit() %>%
as.character()
candidates <- length(remaining)
cols_per_candidate <- candidate_cols_count/candidates
candidate_rows <- rep(remaining,
length.out = candidate_cols_count,
each = cols_per_candidate)
df <- as.data.frame(t(results))
names(df) <- counties
df["Candidate"] <- ''
df[2:(nrow(df)-1), "Candidate"] <- candidate_rows
df <- df %>%
dplyr::select(Candidate, dplyr::everything()) %>%
dplyr::rename("Vote Type" = !!names(.[2])) %>%
tidyr::gather(3:ncol(df), key = "Locality", value = "Votes") %>%
dplyr::arrange(Candidate) %>%
dplyr::mutate(Race = title) %>%
dplyr::select(Race, dplyr::everything())
sheets[[(i-2)]] <- df
}
sheets
}
}
mytest <- read_clarity_results("https://results.enr.clarityelections.com/GA/70059/187898/reports/detailxls.zip", "ga06.zip", tidy_detail = TRUE)
library(devtools)
document()
document()
read_clarity_results <- function(url, destfile, Web01 = FALSE, report = NULL, tidy_detail = FALSE, page_range = NULL) {
if (Web01 == TRUE) {
ID <- stringr::str_extract(url,"[A-Z][A-Z]/[A-Za-z]+/[0-9]+/[0-9]+")
url <- paste("http://results.enr.clarityelections.com/",ID,
switch(report,
csv = "/reports/summary.zip",
xls = "/reports/detailxls.zip",
txt = "/reports/detailtxt.zip",
xml = "/reports/detailxml.zip"), sep = '')
}
download.file(url, destfile)
unzip(destfile)
`%>%` <- magrittr::`%>%`
if (tidy_detail == TRUE) {
message("This function can take a while, especially
if you're importing the entire report.")
message("Please be patient!")
xls <- xml2::read_html("detail.xls")
sheetnumber <- length(rvest::html_text(rvest::html_nodes(xls,
xpath = "//worksheet")))
sheets <- list()
if (is.null(page_range)) {
range <- 3:sheetnumber
} else {
range <- page_range
}
for (i in range) {
rows <- rvest::html_text(rvest::html_nodes(
xls, xpath = paste("//worksheet[",i,"]/table/row", sep = '')))
cols <- strsplit(rows[3], "(?<=[a-z]{2})(?=[A-Z])", perl = TRUE)[[1]]
cols_votes <- cols[2:length(cols)]
cols_count <- length(cols_votes)
candidate_cols_count <- cols_count - 2
everything <- rvest::html_text(rvest::html_nodes(
xls, xpath = paste("//worksheet[",i,"]/table/row/cell", sep = '')))
vote_num <- na.omit(stringr::str_match(everything, "^[0-9]+"))[,1]
cell_count <- length(vote_num)
row_count <- (cell_count/cols_count) + 1
results <- matrix(data = c(cols_votes, vote_num),
nrow = row_count, ncol = cols_count,
byrow = TRUE)
# Take out the column names and vote counts
remaining <- setdiff(setdiff(everything, vote_num), cols_votes)
county_id <- which(remaining %in% cols)
counties <- remaining[county_id:length(remaining)]
remaining <- setdiff(remaining, counties)
title <- remaining[1]
remaining <- remaining[-1] %>%
fill_na() %>%
na.omit() %>%
as.character()
candidates <- length(remaining)
cols_per_candidate <- candidate_cols_count/candidates
candidate_rows <- rep(remaining,
length.out = candidate_cols_count,
each = cols_per_candidate)
df <- as.data.frame(t(results))
names(df) <- counties
df["Candidate"] <- ''
df[2:(nrow(df)-1), "Candidate"] <- candidate_rows
df <- df %>%
dplyr::select(Candidate, dplyr::everything()) %>%
dplyr::rename("Vote Type" = !!names(.[2])) %>%
tidyr::gather(3:ncol(df), key = "Locality", value = "Votes") %>%
dplyr::arrange(Candidate) %>%
dplyr::mutate(Race = title) %>%
dplyr::select(Race, dplyr::everything())
sheets[[(i-2)]] <- df
}
sheets
}
}
?read_clarity_results
read_vertical_results <- function(file, range, colnames) {
`%>%` <- magrittr::`%>%`
pages <- tabulizer::extract_tables(file, pages = range)
elex <- list()
for (i in 1:length(pages)) {
df <- as.data.frame(pages[[i]])
names(df) <- colnames
df <- df[-length(df)]
elex[[i]] <- df
}
all_elex <- as.data.frame(do.call("rbind", elex), stringsAsFactors = FALSE)
all_elex <- all_elex %>%
tidyr::gather(key = "Vote Choice", value = "Votes", -1) %>%
fill_na() %>%
na.omit()
all_elex
}
read_vertical_results("http://www.hudsoncountyclerk.org/elections/Hudson%20Co%202012%20Primary%20SOV%20Totals.pdf", 1:2, colnames = c("Registered Voters",Ballots Cast","% Turnout","Barack OBAMA","Personal Choice"))
read_vertical_results("http://www.hudsoncountyclerk.org/elections/Hudson%20Co%202012%20Primary%20SOV%20Totals.pdf", 1:2, colnames = c("Registered Voters","Ballots Cast","% Turnout","Barack OBAMA","Personal Choice"))
??stringr
?stringr
document()
document()
`%>%` <- magrittr::`%>%`
file <- "http://www.njelections.org/2016-results/2016-municipality-hor-district1.pdf"
pages <- tabulizer::extract_tables(file)
all_elex <- as.data.frame(do.call("rbind", test), stringsAsFactors = FALSE)
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
all_elex <- all_elex %>%
unique() %>%
fill_na() %>%
mutate(Header = ifelse(!is.na(V1) & is.na(V2),V1,NA)) %>%
fill(Header)
?fill
all_elex <- all_elex %>%
unique() %>%
fill_na() %>%
dplyr::mutate(Header = ifelse(!is.na(V1) & is.na(V2),V1,NA)) %>%
tidyr::fill(Header)
all_elex
View(all_elex)
all_elex <- all_elex %>%
unique() %>%
fill_na() %>%
rename(Municipality = '')
?rename
all_elex <- all_elex %>%
unique() %>%
fill_na() %>%
dplyr::rename(Municipality = '')
View(all_elex)
all_elex %>% dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x))))
all_elex[,1]
all_elex[-1]
all_elex[,-1]
all_elex[-1,]
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
all_elex <- all_elex[1,]
all_elex <- all_elex %>%
unique() %>%
fill_na() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Header = ifelse(count_na == 1, Municipality,NA)) %>%
tidyr::fill(Header)
View(all_elex)
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
all_elex <- all_elex[-1,]
all_elex <- all_elex %>%
unique() %>%
fill_na() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Header = ifelse(count_na == 1, Municipality,NA)) %>%
tidyr::fill(Header)
View(all_elex)
all_elex %>%
dplyr::select(Header, everything(), -count_na)
all_elex %>%
dplyr::select(Header, dplyr::everything(), -count_na)
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
#  all_elex <- all_elex[-1,]
all_elex <- all_elex %>%
unique() %>%
fill_na() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Header = ifelse(count_na == 1, Municipality,NA)) %>%
tidyr::fill(Header) %>%
dplyr::select(Header, everything(), -count_na)
#  all_elex <- all_elex[-1,]
all_elex <- all_elex %>%
unique() %>%
fill_na() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Header = ifelse(count_na == 1, Municipality,NA)) %>%
tidyr::fill(Header) %>%
dplyr::select(Header, dplyr::everything(), -count_na)
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
#  all_elex <- all_elex[-1,]
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Header = ifelse(count_na == 1, Municipality,NA)) %>%
tidyr::fill(Header) %>%
dplyr::select(Header, dplyr::everything(), -count_na)
View(all_elex)
?filter
all_elex %>% filter(!(Header = Municipality))
all_elex %>% filter(!(Header == Municipality))
all_elex %>% filter((Header == Municipality))
all_elex %>% filter(Header == Municipality)
all_elex %>% filter(Header == Municipality)
View(all_elex)
all_elex %>% filter(all_elex, Header == Municipality)
all_elex %>% filter(Header==Municipality)
all_elex %>% filter(~Header==Municipality)
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
#  all_elex <- all_elex[-1,]
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Subgroup = ifelse(count_na == 1, Municipality,NA)) %>%
tidyr::fill(Subgroup) %>%
dplyr::select(Subgroup, dplyr::everything(), -count_na) %>%
all_elex
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Subgroup = ifelse(count_na == 1, Municipality,NA)) %>%
tidyr::fill(Subgroup) %>%
dplyr::select(Subgroup, dplyr::everything(), -count_na
all_elex
}
#  all_elex <- all_elex[-1,]
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Subgroup = ifelse(count_na == 1, Municipality,NA)) %>%
tidyr::fill(Subgroup) %>%
dplyr::select(Subgroup, dplyr::everything(), -count_na)
View(all_elex)
all_elex %>% filter(Subgroup == Municipality)
all_elex %>% dplyr::filter(Subgroup == Municipality)
all_elex %>% dplyr::filter(!(Subgroup == Municipality))
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
#  all_elex <- all_elex[-1,]
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Subgroup = ifelse(count_na == 1, Municipality,NA)) %>%
tidyr::fill(Subgroup) %>%
dplyr::select(Subgroup, dplyr::everything(), -count_na) %>%
dplyr::filter(!(Subgroup == Municipality))
all_elex
View(all_elex)
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
#  all_elex <- all_elex[-1,]
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Subgroup = ifelse(count_na == 1, Municipality,NA))
if (sum(!is.na(count_na)) > 0) {
all_elex <- all_elex %>%
tidyr::fill(Subgroup) %>%
dplyr::select(Subgroup, dplyr::everything(), -count_na) %>%
dplyr::filter(!(Subgroup == Municipality))
} else {
all_elex <- all_elex %>%
dplyr::select(everything(), -count_na, -Subgroup)
}
if (sum(!is.na(all_elex$count_na)) > 0) {
all_elex <- all_elex %>%
tidyr::fill(Subgroup) %>%
dplyr::select(Subgroup, dplyr::everything(), -count_na) %>%
dplyr::filter(!(Subgroup == Municipality))
} else {
all_elex <- all_elex %>%
dplyr::select(everything(), -count_na, -Subgroup)
}
all_elex
View(all_elex)
class(all_elex[3])
str(all_elex)
?gather
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
#  all_elex <- all_elex[-1,]
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Subgroup = ifelse(count_na == 1, Municipality,NA))
if (sum(!is.na(all_elex$count_na)) > 0) {
all_elex <- all_elex %>%
tidyr::fill(Subgroup) %>%
dplyr::select(Subgroup, dplyr::everything(), -count_na) %>%
dplyr::filter(!(Subgroup == Municipality))%>%
tidyr::gather(-Subgroup, -Municipality, key = "Candidate", value = "Votes")
} else {
all_elex <- all_elex %>%
dplyr::select(everything(), -count_na, -Subgroup)
}
View(all_elex)
read_results <- function(file) {
`%>%` <- magrittr::`%>%`
pages <- tabulizer::extract_tables(file)
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
#  all_elex <- all_elex[-1,]
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Subgroup = ifelse(count_na == 1, Municipality,NA))
if (sum(!is.na(all_elex$count_na)) > 0) {
all_elex <- all_elex %>%
tidyr::fill(Subgroup) %>%
dplyr::select(Subgroup, dplyr::everything(), -count_na) %>%
dplyr::filter(!(Subgroup == Municipality)) %>%
tidyr::gather(-Subgroup, -Municipality, key = "Candidate", value = "Votes")
} else {
all_elex <- all_elex %>%
dplyr::select(everything(), -count_na, -Subgroup) %>%
tidyr::gather(-Municipality, key = "Candidate", value = "Votes")
}
all_elex
}
read_results("http://www.njelections.org/2017-results/2017-general-election-results-gen-assembly-state-senate-district-01.pdf")
read_results <- function(file) {
`%>%` <- magrittr::`%>%`
pages <- tabulizer::extract_tables(file)
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
#  all_elex <- all_elex[-1,]
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Subgroup = ifelse(count_na == 1, Municipality,NA))
if (sum(!is.na(all_elex$count_na)) > 0) {
all_elex <- all_elex %>%
tidyr::fill(Subgroup) %>%
dplyr::select(Subgroup, dplyr::everything(), -count_na) %>%
dplyr::filter(!(Subgroup == Municipality)) %>%
tidyr::gather(-Subgroup, -Municipality, key = "Candidate", value = "Votes")
} else {
all_elex <- all_elex %>%
dplyr::select(dplyr::everything(), -count_na, -Subgroup) %>%
tidyr::gather(-Municipality, key = "Candidate", value = "Votes")
}
all_elex
}
read_results("http://www.njelections.org/2017-results/2017-general-election-results-gen-assembly-state-senate-district-01.pdf")
file <- "http://www.njelections.org/2017-results/2017-general-election-results-gen-assembly-state-senate-district-01.pdf"
pages <- tabulizer::extract_tables(file)
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
all_elex
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Subgroup = ifelse(count_na == 1, Municipality,NA))
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = '') %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x))))
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = '')
read_results <- function(file) {
`%>%` <- magrittr::`%>%`
pages <- tabulizer::extract_tables(file)
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = !!names(.[1])) %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Subgroup = ifelse(count_na == 1, Municipality,NA))
if (sum(!is.na(all_elex$count_na)) > 0) {
all_elex <- all_elex %>%
tidyr::fill(Subgroup) %>%
dplyr::select(Subgroup, dplyr::everything(), -count_na) %>%
dplyr::filter(!(Subgroup == Municipality)) %>%
tidyr::gather(-Subgroup, -Municipality, key = "Candidate", value = "Votes")
} else {
all_elex <- all_elex %>%
dplyr::select(dplyr::everything(), -count_na, -Subgroup) %>%
tidyr::gather(-Municipality, key = "Candidate", value = "Votes")
}
all_elex
}
read_results("http://www.njelections.org/2017-results/2017-general-election-results-gen-assembly-state-senate-district-01.pdf")
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = !!names(.[1]))
View(all_elex)
pages[[1]]
pages[[1]][-1]
pages[[1]][,-1]
pages[[1]][-1,]
read_results <- function(file, merged_header = FALSE) {
`%>%` <- magrittr::`%>%`
pages <- tabulizer::extract_tables(file)
if (merged_header == TRUE) {
for (i in 1:length(pages)) {
pages[[i]] <- pages[[i]][-1,]
}
}
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = !!names(.[1]))
if (sum(!is.na(all_elex$count_na)) > 0) {
all_elex <- all_elex %>%
tidyr::fill(Subgroup) %>%
dplyr::select(Subgroup, dplyr::everything(), -count_na) %>%
dplyr::filter(!(Subgroup == Municipality)) %>%
tidyr::gather(-Subgroup, -Municipality, key = "Candidate", value = "Votes")
} else {
all_elex <- all_elex %>%
dplyr::select(dplyr::everything(), -count_na, -Subgroup) %>%
tidyr::gather(-Municipality, key = "Candidate", value = "Votes")
}
all_elex
}
read_results("http://www.njelections.org/2017-results/2017-general-election-results-gen-assembly-state-senate-district-01.pdf", merged_header = TRUE)
read_results <- function(file, merged_header = FALSE) {
`%>%` <- magrittr::`%>%`
pages <- tabulizer::extract_tables(file)
if (merged_header == TRUE) {
for (i in 1:length(pages)) {
pages[[i]] <- pages[[i]][-1,]
}
}
all_elex <- as.data.frame(do.call("rbind", pages), stringsAsFactors = FALSE)
names <- as.vector(all_elex[1,])
names(all_elex) <- names
all_elex <- all_elex %>%
fill_na() %>%
unique() %>%
dplyr::rename(Municipality = !!names(.[1])) %>%
dplyr::mutate(count_na = ncol(all_elex)-apply(., 1, function(x) sum(is.na(x)))) %>%
dplyr::mutate(Subgroup = ifelse(count_na == 1, Municipality,NA))
if (sum(!is.na(all_elex$count_na)) > 0) {
all_elex <- all_elex %>%
tidyr::fill(Subgroup) %>%
dplyr::select(Subgroup, dplyr::everything(), -count_na) %>%
dplyr::filter(!(Subgroup == Municipality)) %>%
tidyr::gather(-Subgroup, -Municipality, key = "Candidate", value = "Votes")
} else {
all_elex <- all_elex %>%
dplyr::select(dplyr::everything(), -count_na, -Subgroup) %>%
tidyr::gather(-Municipality, key = "Candidate", value = "Votes")
}
all_elex
}
read_results("http://www.njelections.org/2017-results/2017-general-election-results-gen-assembly-state-senate-district-01.pdf", merged_header = TRUE)
mytest <- read_results("http://www.njelections.org/2017-results/2017-general-election-results-gen-assembly-state-senate-district-01.pdf", merged_header = TRUE)
View(mytest)
document()
